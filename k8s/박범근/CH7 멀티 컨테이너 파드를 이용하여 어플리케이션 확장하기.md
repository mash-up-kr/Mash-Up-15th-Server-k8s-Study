# CH7 멀티 컨테이너 파드를 이용하여 어플리케이션 확장하기

>> 파드 하나에 컨테이너 여러 개를 다룰 수 있다. 대개는 어플리케이션 컨테이너와 함께 헬퍼 컨테이너가 추가되는 형태이다. 한 파드 안에 있는 컨테이너는 같은 가상 환경을 공유한다. 

## 7.1 파드와 컨테이너의 통신
- 파드는 하나 이상의 컨테이너가 공유하는 네트워크 및 파일 시스템을 제공하는 가상 환경이다.
  - 각 컨테이너는 별도의 환경 변수 및 자신만의 프로세스, 서로 다른 기술 스택으로 구성될 수 있다.
  - 파드는 하나의 노드에서 동작하는 하나의 단위이다.
  - 따라서 하나의 파드에 속한 컨테이너는 모두 같은 노드에서 동작한다.
- 같은 파드 안에 있는 컨테이너는 네트워크를 공유한다. 따라서 모든 컨테이너가 파드의 IP 주소를 갖는다.
  - 각 컨테이너는 다른 포트 번호를 통해 트래픽을 받는다.
  - 그리고 같은 파드 안의 컨테이너간 통신은 localhost를 사용한다. 컨테이너는 자신만의 파일 시스템을 갖지만, 파드에서 제공하는 볼륨을 마운트할 수 있으며 이 볼륨을 공유하는 방식으로 컨테이너끼리 정보를 공유할 수 있다.
- 파드 내부 뿐만 아니라, 다른 파드가 특정 파드의 컨테이너 포트에 접근 가능하다.
  - 트래픽을 파드의 특정 포트로 전달하는 서비스를 만들면 이 포트를 주시하는 컨테이너가 요청을 받는다.

### 주의
- 여러 개의 컨테이너를 실행하는 파드는 강력한 기능이지만..
  - 파드는 가상 머신의 대체재가 될 수 없다.
  - 어플리케이션의 모든 컴포넌트를 하나의 파드에 집어넣는 건 지양해야한다.
  - 웹 서버 컨테이너와 API 컨테이너를 한 파드에 몰아넣고 싶을 수는 있지만 파드는 어플리케이션을 구성하는 하나의 단위이다. 파드는 어플리케이션의 단일 컴포넌트에 대응되어야 한다.
  - 컨테이너를 지원하는 컨테이너를 넣을 수는 있지만, 서로 다른 어플리케이션을 함께 넣으면 안된다.
    - 이런 구성을 취하면 독립적으로 업데이트 혹은 스케일링 관리가 힘들어지게 된다.

## 7.2 초기화 컨테이너를 이용한 어플리케이션 시작
- 지금까지는 모든 컨테이너가 병렬로 실행되는 멀티컨테이너 파드를 살펴보았다.
  - 이런 파드의 컨테이너는 모두 동시에 실행되며, 모든 컨테이너의 상태가 Ready가 되어야 파드 역시 준비된 것으로 간주된다.

### 사이드카 패턴
- 추가 컨테이너 (사이드카)가 어플리케이션 컨테이너 (오토바이)를 지원하는 구도를 일컫는다.
- 또한, 어플리케이션 컨테이너가 실행되기 전에 추가 컨테이너를 먼저 실행하여 어플리케이션 실행 준비를 할 수도 있다.
  - 이를 **초기화 컨테이너**라고 한다.

- 초기화 컨테이너는
  - 사이드카와 조금 다른게,
  - 파드 안에 여러 개의 컨테이너를 둘 수도 있고,
  - 파드 정의에 기재된 순서대로 실행되며 각각의 정해진 목표를 달성해야 다음 초기화 컨테이너를 실행한다.
  - 그리고 모든 목표를 만족해야 어플리케이션이나 사이드카 컨테이너를 실행한다.
  
```
init1 -> init2 -> init3 (초기화 모두 완료) -> app or sidecar container start
```

초기화 컨테이너를 통해 레거시 어플리케이션의 설정이나 코드를 변경하지 않고도 연결해줄 수 있다.
- 초기화 컨테이너가 컨피그맵과 환경 변수를 읽어들인 뒤, 설정 파일을 구성하고 레거시 어플리케이션이 설정 파일을 읽어가게끔 진행한다.

-> 하지만 초기화 컨테이너만으로 쿠버네티스 표준 설정 방식을 지원하지 않는 어플리케이션을 모두 지원할 수는 없다. 이처럼 초기화 컨테이너만으로 레거시 어플리케이션을 현대화시킬 수 없을때 사이드카 컨테이너를 이용한다.


## 7.3 어댑터 컨테이너를 이용한 일관성 있는 어플리케이션 관리
- 어플리케이션을 쿠버네티스로 이주하면 어플리케이션 전반에 어떤 일관성의 계층을 추가할 수 있다. 이런 일관성으로 동일한 도구와 동일한 방법으로 어플리케이션을 배치하고 관리할 수 있다.
- 이주하는 모든 어플리케이션의 쿠버네티스 플랫폼의 규칙을 만족할 수는 없다.
  - 이런 경우 사이드카와 같이 어플리케이션과 플랫폼 사이의 어댑터 역할을 맡김으로써 해결할 수 있다. 
  - 로그가 그중에서도 대표적이다.
  - 모든 어플리케이션은 어떤 형태로라도 로그를 남겨야 한다.

### 사이드카 활용
- 도커와 쿠버네티스는 표준 출력으로 남겨진 로그를 수집한다.
  - 레거시 어플리케이션이 파일에 남기거나, 수집할 수 없는 채널에 남긴다면?
  - 사이드카 컨테이너가 로그가 출력되는 파일을 읽어 tail 명령으로 표준 출력 스트림에 출력함으로써 중재자 역할을 할 수 있다.
  - 레거시 어플리케이션에 보통 헬스체크, 로그, 성능 지표 사이드카를 붙여서 활용한다.

## 7.4 외부와의 통신을 추상화하기: 앰버서더 컨테이너
- 엠버서더 컨테이너는 어플리케이션과 외부와의 통신을 제어하고 단순화하는 역할을 한다.
  - 어플리케이션이 localhost 주소로 네트워크 요청을 전달하면 이 요청을 앰버서더 컨테이너가 받아 처리하는 형태다.
  - 프록시 기능을 수행하는 사이드카 컨테이너
- 프록시 뿐만 아니라, 네트워크 전송 계층에 끼워 넣으면 어떤 유형의 트래픽이라도 처리가 가능하다.
 
### 서비스 메시란
- 마이크로 서비스 간 통신을 표준화, 보안화, 가시화하기 위한 인프라 레이어
- 네트워크 통신 자체를 어플리케이션 코드에서 분리해서 투명하게 처리할 수 있게 만들어주는 아키텍처 구성 방식
  - 서비스 간의 요청을 Sidecar Proxy가 대신 처리
  - 프로그래밍 없이 라우팅, 보안, 모니터링 설정 가능
  - 트래픽 흐름, 장애 전파, 인증/인가, 로깅 등을 추상화

```
[ Service A ]
     |
[ Envoy Proxy A ] ---> [ Envoy Proxy B ] ---> [ Service B ]
                          |
                    (Mutual TLS, Retry, Timeout)
```

## 7.5 파드 환경 이해하기
- 파드는 하나 이상의 컨테이너를 감싸는 경계이다.
- 컨테이너는 하나 이상의 프로세스를 감싸는 경계이다.
- 파드는 컴퓨팅의 기본 단위이고, 안에 있는 모든 컨테이너 준비가 끝나야 자신도 준비 상태가 된다.
  - 그리고 서비스는 파드가 준비 상태가 되어야 트래픽을 전달한다.
- 컨테이너가 많아질수록 파드에서 오류가 날 확률이 높아진다.