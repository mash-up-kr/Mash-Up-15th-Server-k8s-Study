# 3. 네트워크를 통해 서비스에 파드 연결하기

파드끼리 통신을 위해 쿠버네티스는 `TCP`, `UDP`를 지원한다.
두 프로토콜은 모두 IP 주소로 트래픽을 제어한다.
하지만 IP 주소는 파드를 대체할 때 주소가 변경된다.
그래서 쿠버네티스는 서비스에 `Address Discovery` 기능을 통해 이르 해결했다.

서비스 : 파드를 드나는 통신 트래픽의 라우팅을 맡는 유연한 리소스

<br>

## 3.1. 쿠버네티스 내부의 네트워크 트래픽 라우팅

2장에서 배운 2가지 사실
1. 파드는 쿠버네티스에서 부여한 IP 주소를 가진 가상환경이다.
2. 파드는 다른 컨트롤러 객체(Deployment)에 의해 생애가 관장되는 "쓰고 버리는" 리소스이다.

위 사실들을 통해 2가지 문제가 발생한다.
1. 새로운 파드로 교체될 때, IP 주소가 바뀐다.
2. 교체된 파드의 새로운 IP 주소를 찾기 어렵다. 새로운 IP 주소는 쿠버네티스 API를 통해서만 파악할 수 있다.

### 3.1.1. IP 문제를 해결하기 위한 쿠버네티스 DNS 서버

따라서 쿠버네티스는 자체적인 `도메인 네임`을 도입하여, `전용 DNS 서버`로 해결하였다.

<img width="438" alt="Image" src="https://github.com/user-attachments/assets/42bddaa3-367c-4484-8c7d-8c301d7b2f78" />

즉, "서비스 이름"이 "도메인 네임"으로 사용된다.

그럼 다음 명령어가 잘 작동할까?

```bash
kubectl exec deploy/sleep-1 - ping -c 1 sleep-2
```

정답은 `NO`
~~ping 명령은 쿠버네티스 서비스에서 지원하지 않는 프로토콜이다.~~
원인은 밑에 나옴

<br>

## 3.2. 파드와 파드 간 통신(내부 <-> 내부)

서비스 유형 중 가장 기본이 되는 것 : `클러스터 IP`
클러스터 내부에서는 이 클러스터 IP에 어떤 노드라도 접근이 가능하다.
즉, 파드와 파드 간 통신에만 쓰이며, 분산 시스템의 컴포넌트에 딱 적합하다.

쿠버네티스에서는 애플리케이션 아키텍처의 세세한 부분까지 직접 YAML에 정의해줘야 한다.
실습 : 2개의 deployment, 1개의 서비스

파드 교체는 늘상 일어나기에 DNS 필요하다.

<br>

## 3.3. 외부 트래픽을 파드로 전달하기(외부 -> 내부)

그렇다면 외부 트래픽은 어떻게 전달하는가? `로드밸런서`

<img width="383" alt="Image" src="https://github.com/user-attachments/assets/e9a4450e-1026-497f-a6aa-7947b4bb552a" />

<br>

### 3.3.1. 쿠버네티스 환경별 로드밸런서 동작 방식
- Docker Desktop
  - 단일 로컬 클러스터
  - 모든 로드밸런서 서비스는 localhost로 노출됨
  - 여러 개 사용 시 포트를 다르게 설정해야 함
- K3s (경량 쿠버네티스)
  - 호스트(가상머신)의 IP로 서비스 노출
  - localhost 또는 가상머신 IP로 접근 가능
  - 포트는 역시 서로 달라야 함
- AKS, EKS (클라우드 환경)
  - 고가용성 멀티 노드 클러스터
  - 클라우드 로드밸런서가 생성되고 공인 IP로 노출
  - 인터넷에서도 접근 가능, IP는 환경마다 다름

- 로컬(Docker/K3s) : 포트로 구분
- 클라우드(AKS, EKS) : 공인 IP

## 3.3.2 노드포트 서비스

노드포트 : 외부에서 클러스터로 들어오은 트래픽을 파드로 전달하는 서비스 리소스 유형

별도의 로드밸런서가 필요없다는 점이 로드밸런서 서비스와 다르다.

<img width="335" alt="Image" src="https://github.com/user-attachments/assets/9fa3ce6c-25ba-4163-9571-862691c331a4" />

단점
- 서비스에서 설정한 모든 포트가 개방되어야 함 -> 유연하지 않다.
- 로드밸런싱 기능 x
- K3s나 도커 데스크톱에서는 잘 작동하지만 Kind에서는 x
  
-> 그래서 실제 사용할 일은 없다.

<br>

## 3.4. 쿠버네티스 클러스터 외부로 트래픽 전달하기(내부 -> 외부)

익스터널네임 : 도메인 네임에 대한 별명

<img width="430" alt="Image" src="https://github.com/user-attachments/assets/f83ca377-6501-4bcb-9c12-1761f4e81742" />

익스터널네임 서비스 : 애플리케이션 설정에 포함하기 어려운 환경 간 차이를 반영할 때 유용


---

### 궁금한 점

Q. 
```bash
# 성공
kubectl exec deploy/sleep-1 -- ping -c 2 $(kubectl get pod -l app=sleep-2 --output jsonpath='{.items[0].status.podIP}')

# 실패
kubectl exec deploy/sleep-1 -- ping -c 1 sleep-2
```
교재에는 "ping 프로토콜이 쿠버네티스에서는 안 된다"고 했는데, 그러면 둘 다 안 돼야 하는 거 아닌가?

A. ping 명령어 자체가 금지된 것은 아님. DNS가 작동하지 않을 수 있다는 의미
클러스터의 DNS가 동작해야만 한다.